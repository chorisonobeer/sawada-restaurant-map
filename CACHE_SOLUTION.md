# スマートフォンキャッシュ問題の解決策

## 問題
Netlifyでデプロイしたアプリにスマートフォンでアクセスすると、キャッシュのせいで古いバージョンが表示され、再読み込みしても最新版が表示されない問題が発生していました。

## 実装した解決策

### 1. Service Worker の即座更新
**ファイル**: `src/index.tsx`
- Service Worker登録時に `onUpdate` コールバックを追加
- 新しいバージョンが利用可能になったら即座に `SKIP_WAITING` メッセージを送信
- 自動的にページをリロードして最新版を適用

### 2. HTTPヘッダーによるキャッシュ制御
**ファイル**: `public/_headers`, `netlify.toml`
- HTMLファイル、manifest.json、Service Workerに対して強力なno-cacheヘッダーを設定
- `Cache-Control: no-cache, no-store, must-revalidate`
- `Pragma: no-cache`
- `Expires: 0`

### 3. バージョンチェックスクリプト
**ファイル**: `public/version-check.js`, `public/index.html`
- ページロード時にタイムスタンプベースのバージョンチェックを実行
- バージョンが変更されている場合、以下を実行：
  - Service Workerの登録解除
  - ブラウザキャッシュの削除
  - ローカルストレージの一部クリア
  - ページの強制リロード

### 4. PWA Manifest の更新
**ファイル**: `public/manifest.json`
- アプリ名を「新潟クラフトビールマップ」に変更
- バージョン情報を追加

## 動作原理

1. **初回アクセス時**:
   - バージョンチェックスクリプトが現在のタイムスタンプを記録
   - Service Workerが正常に登録される

2. **アプリ更新後のアクセス時**:
   - バージョンチェックスクリプトが前回のタイムスタンプと比較
   - 差異を検出した場合、全キャッシュをクリア
   - Service Workerを再登録
   - ページを強制リロードして最新版を表示

3. **Service Worker更新時**:
   - `onUpdate` コールバックが新しいWorkerを検出
   - `SKIP_WAITING` で即座に新しいWorkerをアクティブ化
   - 自動的にページをリロード

## 効果

- ✅ スマートフォンでのキャッシュ問題を解決
- ✅ アプリ更新時の即座反映
- ✅ ユーザーの手動操作不要
- ✅ PWAとしての機能を維持
- ✅ パフォーマンスへの影響を最小限に抑制

## 注意事項

- バージョンチェックはタイムスタンプベースのため、デプロイ毎に新しいバージョンとして認識されます
- 初回アクセス時は若干の読み込み時間が発生する可能性があります
- ローカル開発環境では Service Worker の動作が異なる場合があります

## 確認方法

1. アプリをデプロイ
2. スマートフォンでアクセス
3. 開発者ツールのコンソールで以下のメッセージを確認：
   - `Service Worker registered successfully`
   - `New version detected, clearing cache...` (更新時)

## トラブルシューティング

### それでもキャッシュが残る場合
1. ブラウザの設定から「サイトデータを削除」
2. プライベートブラウジングモードでアクセス
3. ブラウザアプリを完全に終了してから再起動

### 開発時の注意
- ローカル開発時は `localStorage.clear()` でバージョン情報をリセット可能
- Service Worker の動作確認は本番環境で行うことを推奨