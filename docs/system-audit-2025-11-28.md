# システム全体監査レポート（2025-11-28）

## 概要
- 対象: 佐和田料飲店マップ（React + TypeScript）
- 目的: パフォーマンス/UX/保守観点での脆弱点・無駄処理・遅延要因の洗い出しと、修正要否の判定
- 結論: 重大なロジック破綻は見当たらず。スクロール・背景・追加読み込み周辺の調整で UX が安定。いくつかの軽微改善余地あり。

## 監査サマリー
- 高優先修正（推奨: すぐ対応）
  1) スクロール終端の描画干渉を「レイアウト余白＋ガター」で固定化
     - 参照: `src/App.scss:10-12`
     - 影響度: 4/5 | 修正難易度: 2/5 | 対応状況: 対応済み

- 中優先修正（推奨: 次回改修で実施）
  2) IntersectionObserver の root を固定要素に依存（`.app-body`）
     - 参照: `src/App/List.tsx:384-400`
     - 影響度: 3/5 | 修正難易度: 2/5 | 判定: そのまま（安定運用されているため）
  3) 位置情報・距離計算のキャッシュ寿命管理（メモリマップの肥大化防止）
     - 参照: `src/App/List.tsx:83-98`
     - 影響度: 3/5 | 修正難易度: 2/5 | 判定: 実害小。必要なら LRU 化を検討

- 低優先修正（推奨: 様子見）
  4) 画像プロキシの URL 判定強化（Google Drive 以外のホスト）
     - 参照: `src/App/hooks/useShopData.ts:1-43` / `src/App/ShopListItem.tsx:7-43`
     - 影響度: 2/5 | 修正難易度: 2/5 | 判定: 必要なら正規表現の拡張
  5) GA のローカル送信失敗ログ（UX影響なし）
     - 参照: `public/index.html:87-98`
     - 影響度: 1/5 | 修正難易度: 1/5 | 判定: 無視可（本番のみ計測有効なら問題なし）

## 詳細評価

### A. データ取得/正規化/キャッシュ
- CSV 解析と正規化
  - 概要: PapaParse でヘッダ付き CSV を解析。`sanitizeShop` により全フィールドを文字列化＋座標の半角化＋画像 URL の補正。
  - 参照: `src/App/hooks/useShopData.ts:97-150`
  - 評価: 4/5（妥当）
  - 懸念: 地理座標は文字列化後に距離計算側で `parseFloat`。現状問題なし。
  - 対応方針: 変更不要。

- キャッシュ戦略（IndexedDB）
  - 概要: `getJSON/setJSON` で TTL 管理（分単位）。`shopListCache:v2` を採用。
  - 参照: `src/utils/idbStore.ts:1-23` / `src/App/hooks/useShopData.ts:97-110`
  - 評価: 4/5（適切）
  - 懸念: TTL の粒度は 24h（1440分）。更新頻度によっては古さを感じる場面があり得る。
  - 対応方針: 必要に応じて TTL 調整（現状維持）。

### B. リスト表示/スクロール/追加読み込み
- 末尾検知の冗長化（onScroll＋IntersectionObserver → 現在は IO のみ）
  - 概要: `.app-body` を root とした IO で末尾 `sentinel` を監視し、`loadMore()` を発火。
  - 参照: `src/App/List.tsx:384-400`
  - 評価: 4/5（安定）
  - 懸念: root セレクタが変化したときの安全性（現状の構造では恒常的に存在）。
  - 対応方針: 変更不要。

- スクロール終端の干渉解消
  - 概要: `.app-body` の `padding-bottom`＋`scrollbar-gutter: stable` でタブバーとの視覚干渉を解消。
  - 参照: `src/App.scss:10-12`
  - 評価: 5/5（UX向上）
  - 対応方針: 完了。

- リストコンテナ背景の途切れ問題
  - 概要: `.shop-list` / `.shop-list-content` を `height: auto` に修正し、背景が末尾まで伸びるように。
  - 参照: `src/App/List.scss:1-24`
  - 評価: 5/5（解消）
  - 対応方針: 完了。

### C. 距離計算・並列化
- Web Worker＋フォールバック計算
  - 概要: Worker で距離計算、失敗時はバッチ計算へフォールバック。計算結果をメモリキャッシュ化。
  - 参照: `src/App/List.tsx:42-75` / `src/App/List.tsx:99-132`
  - 評価: 4/5（スケール）
  - 懸念: `distance-worker.js` のパスが存在しない環境では常にフォールバック。性能影響は軽微（BATCH_SIZE=50）。
  - 対応方針: 変更不要（必要性が出たら Worker の設置）。

- キャッシュの生存期間・掃除
  - 概要: `distanceCache` はメモリ常駐。セッション継続で増加可能。
  - 参照: `src/App/List.tsx:83-98`
  - 評価: 3/5（軽微）
  - 対応方針: LRU 上限（例: 200件）と定期クリアの追加は検討余地。

### D. 画像最適化/プロキシ
- 画像 URL のプロキシ化（Google Drive）
  - 概要: 各種 Drive URL から ID 抽出、環境に応じプロキシへ差し替え。
  - 参照: `src/App/hooks/useShopData.ts:1-43` / `src/App/ShopListItem.tsx:7-43`
  - 評価: 3/5（妥当）
  - 懸念: Drive 以外のホストは通過（安全だが最適化はされない）。
  - 対応方針: 必要に応じて最適化（srcset/sizes、圧縮）を拡張。

### E. レイアウト/アクセシビリティ
- タブバー干渉
  - 概要: ウィンドウスクロール禁止＋`.app-body` 単独スクロールに統一。
  - 参照: `src/index.scss:31-38` / `src/App.scss:7-12`
  - 評価: 4/5（安定）
  - 対応方針: 完了。

- カード可読性（タイトル/背景/パディング）
  - 概要: タイトルの太字化・色調整、左右均等パディング、薄い白背景と影。
  - 参照: `src/App/ShopListItem.scss:33-43` / `src/App/List.scss:26-56`
  - 評価: 4/5（改善）
  - 対応方針: 完了。

### F. サービスワーカー/バージョン管理
- SW 登録と CRA 既定の戦略
  - 概要: 本番のみ SW 登録。localhost は開発向けログ。
  - 参照: `src/serviceWorkerRegistration.ts:26-58`
  - 評価: 4/5（標準的）
  - 対応方針: 変更不要。

- バージョン管理の二重化傾向
  - 概要: `public/version-check.js` と `src/utils/versionManager.ts` の役割がやや重複。
  - 参照: `POTENTIAL_ISSUES.md:1-14` / `src/utils/versionManager.ts:221-231`
  - 評価: 3/5（混乱の芽）
  - 対応方針: どちらかに統一（次回改修候補）。

### G. 検索機能（フィルタ/ソート）
- フィルタリング→ソート→結果通知の流れ
  - 概要: テキスト/カテゴリ/タグ/営業時間/駐車場の複合フィルタ。整合性は良好。
  - 参照: `src/App/SearchFeature.tsx:290-332`
  - 評価: 4/5（良好）
  - 懸念: 大規模データで再計算コスト増加の可能性。
  - 対応方針: 必要ならメモ/分割計算導入。

## 推奨アクション（要否判断）
- 即時修正: なし（既対応で安定）。
- 次回改修候補:
  - 距離キャッシュの LRU 上限（例: 200件）＋定期クリア（影響度: 中）
  - 画像最適化の拡張（`srcset/sizes`、必要なら WebP/AVIF）（影響度: 低〜中）
  - バージョン管理ロジックの統一（影響度: 中）

## 付記
- ローカル開発の画像プロキシ（5050）が既起動だと競合します。
  - 参照: 実行ログ（`scripts/local-image-proxy.js`）
  - 対応: 既起動検知→ポート変更の改善余地あり（現状は手動対処で十分）。

---
本レポートは軽微な不具合や UX 改善余地を中心に評価しています。重大障害は確認していませんが、今後の拡張に備えて上記「次回改修候補」を検討すると堅実です。
