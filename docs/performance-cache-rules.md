# 高速表示・キャッシュ運用ルール

目的：すべてのタブでキャッシュを即時表示し、バックグラウンドで最新化（SWR）する。遅延やブロッキングを排除し、ユーザー体験を常に軽快に保つ。

## 高速表示の原則
- 初期レンダリングは UI 枠（スケルトン含む）を 100ms 以内に表示する。
- データは `IndexedDB > localStorage > ネットワーク` の順で参照し、見つかった時点で即表示する。
- SWR（Stale-While-Revalidate）：キャッシュを即時描画 → 背景で再取得 → 差分があれば非破壊更新。
- 取得失敗・タイムアウト時も既存キャッシュを維持し、UI は安定させる。

## 位置情報（最重要）
- UI ブロッキング禁止：位置情報取得の待ち（許可待ちやタイムアウト）で初期表示を止めない。
- `askGeolocationPermission` は UI に影響させない。`Promise.race([getLocation, timeout(300ms)])` で UI を即時継続。
- `GeolocationContext` のキャッシュがある場合のみ距離ソートを“同期的に開始”。キャッシュが無ければ未ソートで即表示。
- 未取得時は「未ソート（または前回距離キャッシュ）」を表示 → バックグラウンド距離計算完了で差し替え。
- 位置情報のハードタイムアウトは最大 2000ms。UI のブロッキング許容は 0ms。

## 距離計算（重い処理の扱い）
- Web Worker を用いたオフメインスレッド化を推奨（主スレッドを塞がない）。
- `@turf/turf` はライブラリ全体ではなく必要なモジュールのみを個別インポートする（Bundle を軽量化）。
- バッチ実行は `requestIdleCallback` または `setTimeout(0)` を併用し、UI 優先にスケジューリング。
- 1 バッチの計算件数は 50 以下。連続実行時は必ず yield を入れて描画機会を確保。
- 大規模リスト時は「先頭 N 件のみ距離計算→順次拡張」の段階的適用。

## データ比較・差分適用
- 大規模配列に対する `JSON.stringify` による全量比較は禁止（CPU/Garbage Collector の負荷大）。
- 比較は「最終更新タイムスタンプ」「件数」「簡易ハッシュ（例：一部フィールドの rolling hash）」などの軽量指標で行う。
- 差分適用は UI 非破壊で、並び替え・フィルタ結果の更新も段階的に行う。

## 画像・地図の扱い
- 地図は必要ページでのみマウントする（ホーム専用等）。非表示ページでの常時マウント禁止。
- 地図コンポーネントは遅延読み込み（React.lazy + Suspense）を維持し、初期描画を軽量化。
- 画像は `loading="lazy"` を徹底、サムネイルサイズの最適化とプレースホルダー（LQIP/Skeleton）併用。

## 計測・監視
- `performance.mark/measure` を導入：`list:init:start/end`, `geolocation:wait`, `distance:compute` などの区間を常時計測。
- 初期表示までの TTI（Time To Interactive）と LCP（Largest Contentful Paint）をダッシュボード表示。
- 計測結果は `console.table` で開発中に可視化。CI では Lighthouse/Web Vitals を自動収集。

## エラー時の非破壊ポリシー
- ネットワークエラー・パースエラー時も既存キャッシュは維持。UI は落とさず、静かな再試行を行う。
- 重大エラーはトースト等の非同期通知で知らせ、ページ全体の再読み込みは禁止。

## 実装チェックリスト（導入時の確認項目）
- [ ] キャッシュが存在する場合、一覧は 100ms 以内に初期表示されるか。
- [ ] 位置情報未取得時でも一覧が即表示されるか（距離ソートは後追い）。
- [ ] 距離計算は UI をブロックしていないか（Web Worker/バッチで分割）。
- [ ] `@turf/turf` のインポートは必要モジュールのみに限定されているか。
- [ ] 差分判定に `JSON.stringify` を使っていないか（軽量指標へ置換）。
- [ ] 画像は遅延読み込み、地図は必要ページのみマウントか。
- [ ] 計測（mark/measure）と Web Vitals の収集が有効か。
- [ ] エラー時でも既存キャッシュが保持され、UI は崩れないか。

## 運用方針
- 上記ルールは新規機能・改修時に必ず適用し、PR テンプレートでチェックする。
- 計測結果がしきい値（初期表示 100ms/TTI 2s/LCP 2.5s）を超過した場合は、原因分析を必須化する。