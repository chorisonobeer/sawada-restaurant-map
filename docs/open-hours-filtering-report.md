# 営業時間フィルタリングの現行仕様 詳細報告書

作成日: 2025-10-26
作成者: 開発支援（自動生成）
対象リポジトリ: `sawada-restaurant-map`

## 概要
本報告書は、「現在営業中」フィルタの挙動をコードベースから調査し、現行仕様・入力フォーマット・判定アルゴリズム・既知の制約・改善ポイントを体系的にまとめたものです。

## 実装位置
- ファイル: `src/App/SearchFeature.tsx`
- 関数: `isShopOpen(shop: Pwamap.ShopData): boolean`
- 参照箇所: フィルタリング処理 `filterShops()` 内で `isOpenNow` が有効なときに `!isShopOpen(shop)` を除外条件として使用

```ts
// 主要箇所（抜粋）
// 営業時間の判定
const isShopOpen = (shop: Pwamap.ShopData): boolean => {
  if (!shop['営業時間']) return false;

  const now = new Date();
  const utc = now.getTime() + now.getTimezoneOffset() * 60000;
  const jstNow = new Date(utc + 9 * 60 * 60000);
  const currentHour = jstNow.getHours();
  const currentMinute = jstNow.getMinutes();
  const currentTimeMinutes = currentHour * 60 + currentMinute;
  const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][jstNow.getDay()];

  // 定休日チェック
  if (shop['定休日']) {
    const closedDays = shop['定休日']
      .split(/,|、|\s+/)
      .map(day => day.trim())
      .filter(day => day !== '');
    if (closedDays.some(day => day.includes(dayOfWeek))) {
      return false;
    }
  }

  // 営業時間チェック（単一レンジ）
  const timeRangeMatch = shop['営業時間'].match(/(\d{1,2}):(\d{2})\s*[-～]\s*(\d{1,2}):(\d{2})/);
  if (!timeRangeMatch) return false;

  const [, startHourStr, startMinuteStr, endHourStr, endMinuteStr] = timeRangeMatch;
  const startHour = parseInt(startHourStr, 10);
  const startMinute = parseInt(startMinuteStr, 10);
  const endHour = parseInt(endHourStr, 10);
  const endMinute = parseInt(endMinuteStr, 10);
  const startTimeMinutes = startHour * 60 + startMinute;
  const endTimeMinutes = endHour * 60 + endMinute;

  if (endTimeMinutes < startTimeMinutes) {
    // 深夜営業（例：22:00-02:00）
    return currentTimeMinutes >= startTimeMinutes || currentTimeMinutes <= endTimeMinutes;
  } else {
    // 通常営業
    return currentTimeMinutes >= startTimeMinutes && currentTimeMinutes <= endTimeMinutes;
  }
};
```

## 入力データ仕様（期待値）
- `営業時間`（例）
  - 形式: `HH:MM-HH:MM` または `HH:MM～HH:MM`
  - 半角数字とコロン必須。区切りは半角ハイフン `-` または全角波ダッシュ `～`。
  - 単一の時間帯のみを想定。複数時間帯（昼営業＋夜営業）には未対応。
- `定休日`（例）
  - 形式: `月, 火` / `月・火` / `月 火` / `月,火` / `月曜` 等の自由記述
  - パース: `/,|、|\s+/` で分割した各要素の文字列に当日（`日月火水木金土`）の漢字が含まれるかどうかで判定
  - 当該曜日が含まれていれば「休業」とみなす

## 判定アルゴリズム詳細
1. JST固定の現在時刻を生成
   - 端末ローカル時刻から UTC を計算し、`+9時間` して `jstNow` を作成
   - これにより端末タイムゾーンが海外でも判定は常に日本時間準拠
2. `定休日` 判定
   - `shop['定休日']` が存在する場合のみ実施
   - `/,|、|\s+/` で分割→空要素除去→各要素に当日漢字が「含まれているか」を `includes()` で確認
   - 1つでも該当すれば直ちに `false`（休業）
3. `営業時間` 判定
   - 文字列から正規表現 `/(\d{1,2}):(\d{2})\s*[-～]\s*(\d{1,2}):(\d{2})/` で単一レンジ抽出
   - 抽出失敗時は `false`（営業時間不明扱い）
   - 抽出成功時は分を整数化して現在分 `currentTimeMinutes` と比較
   - 深夜跨ぎ（終了 < 開始）の場合は「開始以降」または「終了以前」を OR で判定
   - 通常時は開始以上かつ終了以下の AND 判定

## 取り扱い例（期待挙動）
- `12:00-14:30` → 12:00〜14:30 のみ営業とみなす
- `18:00～23:00` → 18:00〜23:00 のみ営業とみなす
- `22:00-02:00` → 当日 22:00〜24:00 と翌日 00:00〜02:00 を連続営業とみなす（深夜跨ぎ対応）
- `定休日: 月, 火` → 月曜または火曜は休業（`includes()` により柔軟に一致）
- `定休日: 不定休` → 当日漢字に一致しないため休業判定はされない（常に営業時間側で判定）

## 想定外入力と現行挙動
- 複数時間帯（例: `11:00-14:00, 17:00-22:00`）
  - 正規表現は「最初の1レンジ」にしか一致しないため、後半時間帯は無視→誤判定の可能性
- オープンエンド（例: `18:00-` や `18:00-24:00`）
  - `-` のみや `24:00` は仕様外（`24:00` は 1440 分になり上限超過ロジックなし）
- 曜日別営業時間（例: `月-金 11:00-15:00 / 土日 10:00-18:00`）
  - 曜日記述を時間帯の抽出に使っていないため未対応
- 文言のみ（例: `ランチのみ`, `準備中`, `予約制`）
  - 正規表現不一致→常に `false`
- 全角数字や「時」「分」表記（例: `１１時〜２２時`）
  - 正規表現が半角数字前提のため不一致→ `false`

## 既知の制約 / リスク
- 単一レンジ限定のため、多くの実店舗の「昼・夜」営業に対応できていない
- 曜日差（平日/週末/祝日）に応じた営業時間変更に未対応
- `includes()` による定休日一致は曖昧一致（例: `木曜夜` でも当日が木なら休業とみなす）
- 入力の書式揺れ（全角/半角/区切り文字）が多いと正規表現不一致で常に休業扱いになる
- `24:00` 等の境界値や異常値に対するバリデーションがない

## 依存関係・関連コード
- `SearchFeature.tsx` の `filterShops()` 内で `isOpenNow` が true の時だけ `isShopOpen` 適用
- 表示側（`Shop.tsx`, `ShopListItem.tsx`）は `営業時間` / `定休日` をテキスト表示するのみ（判定ロジックは持たない）

## 改善案（提案）
1. 複数時間帯への対応
   - `営業時間` 文字列を `/,|、|\s*\/\s*/` などで分割し、各レンジをパースして「いずれかに一致」で判定
   - 例: `11:00-15:00, 17:00-22:00` を 2 レンジに分割して OR 判定
2. 曜日別のパターン対応
   - `月-金 11:00-15:00 / 土日 10:00-18:00` のような書式を認識
   - 現在曜日で該当するレンジのみを適用
3. 入力揺れに強いパーサ
   - 全角数字・「時/分」・日本語区切り（〜、から、まで）を正規化（`zen2han` の活用）
   - 失敗時フォールバック（「未知だが営業中の可能性あり」など）
4. 厳密な定休日判定
   - `includes()` ではなく曜日を正規化し、完全一致または範囲一致（例: `月〜水`）対応
   - `不定休` や `祝日` を特別扱い（祝日テーブルを用意する場合は別途）
5. バリデーション / ロギング
   - フィルタ判定に失敗した店舗をカウント・ログ出力し、データ入力にフィードバック

## 改修方針（サンプル案）
- `parseBusinessHours(raw: string, jstDate: Date, day: string): { open: boolean, matchedRanges: Array<[number,number]> }` を新設
- ステップ
  1. 全角→半角、表記ゆれを正規化
  2. 曜日セグメント（`月-金` / `土日`）を抽出し、当日該当セグメントのみ対象に
  3. 時間レンジを複数抽出（`HH:MM-HH:MM` パターンを全探索）
  4. 深夜跨ぎを分割（例: `22:00-02:00` → `[1320, 1440]` と `[0, 120]`）
  5. `currentMinutes` がいずれかのレンジに含まれるかで判定
- 定休日は `normalizeClosedDays()` を導入して完全一致・範囲一致・特別語（`不定休`）を明確化

## まとめ
現行の「現在営業中」フィルタは、
- JST固定の現在時刻
- 定休日の簡易一致（当日漢字を含むか）
- `HH:MM-HH:MM` / `HH:MM～HH:MM` の単一時間帯
- 深夜跨ぎの OR 判定
に基づく比較的シンプルな仕様です。多様な記述揺れ・複数レンジ・曜日別時間帯を扱うためには、上記改善案にあるパーサ強化と仕様拡張が有効です。

## 改修プラン（段階的）
- フェーズ1（複数時間帯対応・データ変更なし）
  - 目的: 単一レンジ制限を解消し「昼＋夜」など複数レンジを OR 判定で扱えるようにする。
  - 実装: `parseBusinessHours(raw)` を新設し、`HH:MM-HH:MM` パターンを全探索して複数レンジ配列を返す。`isShopOpen()` はこの配列を使っていずれか一致で開店判定。
  - 正規化: 全角→半角、`〜/～`→`-`、余分な空白除去。分割子は `,` と `、` を許容。
  - 深夜跨ぎ: 各レンジを `[start,end]` 分にし、`end < start` は `[start,1440]` と `[0,end]` に分割。
  - 受入条件: `11:00-14:00, 17:00-21:00` で両レンジを正しく判定。既存の単一レンジ・定休日挙動は不変。
- フェーズ2（曜日セグメント対応）
  - 目的: 曜日ごとに異なる営業時間（平日/週末）を表現・判定可能にする。
  - 入力仕様（暫定）: セグメントを `;` 区切り、各セグメントは `[曜日式] 時間レンジ(, 時間レンジ)*`。例: `[月-金] 11:00-15:00, 17:00-21:00; [土日] 10:00-18:00`。
  - 解析: `曜日式` は `月,火,水,木,金,土,日,祝`、範囲 `月-金`、結合 `土日` を許容。現在曜日にマッチするセグメントのみを対象。
  - 受入条件: 上記例で平日・土日それぞれの時間帯が正しく適用されること。
- フェーズ3（バリデーション・ロギング・データ品質）
  - 目的: 入力の揺れや誤記を検知・是正できるようにする。
  - 実装: パース失敗・異常値（`24:00`/負値/60分超）を検出し、コンソール/レポートに集計。編集用ドキュメントにフィードバック。
  - 受入条件: 失敗店舗一覧が生成され、改善が可能。
- フェーズ4（ドキュメント・運用整備）
  - 目的: データ入力ルールの明文化と移行ガイド提供。
  - 実装: 本ファイルの「推奨データフォーマット」を元に、管理者向け手順書を `docs/data-entry-guidelines.md` に整備。既存データの一括正規化スクリプトを追加（任意）。

### 影響範囲・変更点
- 影響: `SearchFeature.tsx` の `isShopOpen()`、ユーティリティ新設（`parseBusinessHours` / 正規化関数）。
- 非影響: UI（表示文言）は原則変更なし。CSV/JSONスキーマ変更はフェーズ2以降の任意。
- テスト: ユニット（複数レンジ/深夜跨ぎ/曜日適用/失敗系）、統合（`filterShops` の isOpenNow フラグ）。

## 営業時間セル 推奨データフォーマット（入力ルール）
- 基本形（毎日同一）: `HH:MM-HH:MM[, HH:MM-HH:MM...]`
  - 例: `11:00-14:00, 17:00-21:00`
  - 仕様: 24時間制・半角数字、区切りはカンマ。範囲は `-` または `～` 許容。
- 深夜跨ぎ: `22:00-02:00` のようにそのまま記載（翌日まで連続営業時間として扱う）。
- 曜日セグメント（任意・推奨）: セミコロン `;` で区切り、各セグメント先頭に角括弧で曜日式を付与。
  - 曜日式の例: `[月-金]`, `[土日]`, `[祝]`, `[月,水,金]`
  - 記述例: `[月-金] 11:00-15:00, 17:00-21:00; [土日] 10:00-18:00`
- スペース・全角: 半角数字・半角コロンを基本とし、全角ダッシュ `～` は許容・正規化。余分なスペースは任意。
- 非推奨表記（避ける）: `ランチのみ`, `準備中`, `朝〜夜` など数値の無い記述。`24:00` や `25:00` など境界外数値。

### フォーマットの簡易仕様（準正式）
- セグメント: `[曜日式] 時間レンジ(, 時間レンジ)*`
- 曜日式: `月|火|水|木|金|土|日|祝`（`,` で列挙、`-` で範囲、結合語 `土日` 許容）
- 時間レンジ: `H{1,2}:M{2} - H{1,2}:M{2}`（`-`/`～` 許容、先頭ゼロ可）
- セグメント区切り: `;`（セミコロン）
- 既定適用: 曜日式が無い場合は「毎日適用」セグメントとして扱う。

### 入力例
- 毎日: `11:30-14:30, 17:00-21:30`
- 平日/週末: `[月-金] 11:00-15:00, 17:00-21:00; [土日] 10:00-18:00`
- 深夜: `20:00-02:00`
- 個別曜日: `[月,水,金] 12:00-15:00`

※ `定休日` は引き続き別フィールドで管理し、曜日セグメントと矛盾する場合は「定休日を優先（休業）」とするのが運用上安全です。