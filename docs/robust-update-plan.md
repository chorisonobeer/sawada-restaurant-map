# 安全な更新・表示維持 実装計画

## ゴール
- 一覧が「外部遷移や復帰のきっかけ」で空にならない設計へ全面是正
- 更新検知は非破壊（キャッシュ削除や強制リロード禁止）
- 取得は stale-while-revalidate（即時キャッシュ表示→背景で最新化）
- 復帰時も常に前回表示を維持し、静かに更新

## フェーズ構成
- フェーズ1（基盤）: 更新チェックの非破壊化（VersionManager/Index/Version-check）
- フェーズ2（SW）  : Service Worker で SWR 戦略・更新通知を実装
- フェーズ3（データ）: 店舗/イベントデータを IndexedDB 主体のキャッシュへ移行
- フェーズ4（仕上げ）: デバッグ・計測・微調整

## タスク一覧
- [ ] F1-1 VersionManager の破壊的操作を撤廃（キャッシュ/リロード禁止）
- [ ] F1-2 index.tsx の beforeunload 破壊処理を撤廃
- [ ] F1-3 version-check.js を非破壊化（情報記録のみ）
- [ ] F2-1 Service Worker に SWR 追加（CSV/動的）
- [ ] F2-2 SW 更新時のクライアント通知（UIは簡易）
- [ ] F3-1 IndexedDB ユーティリティ追加
- [ ] F3-2 App.tsx を IDB 先行（即時表示）＋差分更新化
- [ ] F3-3 Events.tsx を IDB 先行＋差分更新化
- [ ] F4-1 シナリオテスト（外部リンク往復/オフライン/遅延）
- [ ] F4-2 ログ/計測と最終調整

## 進捗（更新時に適宜記入）
- フェーズ1: 完了（VersionManager非破壊化／index.tsx beforeunload削除／version-check.js 非破壊化）
- フェーズ2: 進行中（SW更新非強制化 完了、デバウンス＋更新トースト 実装）
- フェーズ3: 未着手
- フェーズ4: 未着手

# 一覧の高速性と堅牢性改善プラン

目的: ブラウザのリロード等あらゆる状況でも一覧が確実に表示され、かつ高速に動作するように、データ取得・キャッシュ・初期化・距離ソートを総合的に強化する。

## 課題の整理
- 初回リロード直後に `props.data` が空のまま `dataCache` に空配列が保存され、以後も空キャッシュが優先されて一覧が表示されない。
- CSVデータの緯度/経度が厳格判定で弾かれ、全件除外される場合がある（全角・空白含み・文字列フォーマット差）。
- カテゴリ指定でゼロ件時にUIが無表示となる（ユーザ認知が困難）。
- 距離計算の失敗（Worker/Fallback）自体は表示ブロックしないが、計測・ログの見える化が必要。

## 改善方針
1. List.tsx のキャッシュ読み書きを堅牢化
   - 空配列をキャッシュに保存しない（非空のみ保存）。
   - `cachedData` が空かつ `props.data` が非空ならキャッシュを無視して非空データを採用。
   - 距離ソート済みキャッシュも同様に空は無視。
2. CSVパース緩和（App.tsx）
   - `zen2han` + `trim` を適用後 `parseFloat` による数値化、`Number.isFinite` での妥当性判定。
   - 厳格な正規表現 `^[0-9]+(\.[0-9]+)?$` を廃止し、実データの揺れに耐性を持たせる。
3. UIフィードバックを改善
   - カテゴリゼロ件時に明示的なメッセージを表示（一覧が空の時の認知性向上）。
4. 計測とログ
   - 既存の `performance.mark/measure` を活用しつつ、距離ソート失敗時の警告を維持。

## 実施タスク
- [ ] List.tsxの空キャッシュ回避と非空のみキャッシュ
- [ ] App.tsxのCSV緩和パース（zen2han+parseFloat）
- [ ] List.tsxのゼロ件メッセージ表示追加
- [ ] プレビューで挙動検証（通常・カテゴリ指定・リロード直後・ネットワーク遅延想定）

## 完了判定
- リロード直後でも一覧が非ブロッキングで表示（少なくとも初期 `INITIAL_LOAD_SIZE` 件）。
- CSVのフォーマット揺れでも表示が成立（緯度経度が妥当な場合）。
- カテゴリゼロ件時に明示的メッセージが表示される。
- Worker失敗時でもフォールバックで距離が計算され順序が定まる（または位置情報なしなら元順序）。

## リスクと緩和
- キャッシュキー粒度: カテゴリや位置座標変化によるキャッシュ不整合 → 非空判定で安全側に倒す（非空があるならそれを採用）。
- CSVの不正値: `parseFloat` 後の `isNaN`/`isFinite` で除外し、異常値を最小限に抑える。