# 地図表示のパフォーマンスと安定性に関する調査報告書

## 1. 調査概要
ユーザーより報告のあった「地図の表示が安定しない、起動が遅い」という現象について、コードベースおよび設定の確認を行いました。
特にアプリ起動時の挙動に焦点を当て、実装の安全性と費用対効果（実装コスト対効果）を評価しました。

## 2. 調査結果と原因分析

### 2.1 不安定さの原因：初期化の競合（Race Condition）
現在の `src/App/Map.tsx` の実装において、地図ライブラリ（Geolonia/MapLibre）の読み込み完了を待たずに初期化処理が走る可能性があります。

*   **現状**: `public/index.html` の `<body>` 末尾で `cdn.geolonia.com` のスクリプトを読み込んでいます。
*   **問題点**: Reactアプリケーションのバンドルサイズが比較的小さいため、ネットワーク環境によっては外部のGeoloniaスクリプトが読み込まれる前に `Map` コンポーネントがマウントされる可能性があります。
*   **コード**: `const { geolonia } = window;` と記述されていますが、この時点で `geolonia` が `undefined` の場合、続く `new geolonia.Map(...)` でエラーが発生し、地図が表示されません（白い画面のまま、あるいはクラッシュ）。

### 2.2 遅さの原因：スクリプト読み込みと接続オーバーヘッド
*   **シリアルな読み込み**: ブラウザはHTMLをパースし終わってからスクリプトのダウンロードを開始します。
*   **接続コスト**: `cdn.geolonia.com` へのDNS解決、TCP接続、SSLハンドシェイクがスクリプト要求時に発生しており、これが初期表示の遅延につながっています。

## 3. 改善案と評価

以下の2点の修正を提案します。

### 案1: 地図ライブラリ読み込み待機処理の追加（必須）

`Map.tsx` において、`window.geolonia` が利用可能になるまで初期化を遅延させるロジックを追加します。

*   **実装内容**: `useEffect` 内で `window.geolonia` の存在を確認し、存在しない場合はタイマーまたはイベントで待機する処理を加えます。
*   **費用対効果**: **極めて高い**。
    *   実装コスト：低（数十行のコード修正）。
    *   効果：読み込みタイミングによるクラッシュや表示不全を完全に防げます（安定性向上）。
*   **安全性**: **高**。既存の機能を損なうことなく、堅牢性を高める修正です。

### 案2: リソースヒント（Preconnect）の追加（推奨）

`public/index.html` に `preconnect` タグを追加し、ブラウザに早期に接続を確立させます。

*   **実装内容**: `<link rel="preconnect" href="https://cdn.geolonia.com" />` を `<head>` に追加。
*   **費用対効果**: **高い**。
    *   実装コスト：極めて低（1行追加）。
    *   効果：数百ミリ秒程度の表示高速化が見込まれます。
*   **安全性**: **高**。副作用はありません。

## 4. 推奨される修正手順

以下の手順で修正を行うことを推奨します。

1.  `public/index.html` に `preconnect` タグを追加。
2.  `src/App/Map.tsx` を修正し、`window.geolonia` のポーリング監視（またはロード待機）を追加。

この修正により、アプリ起動時の地図表示の確実性が保証され、体感速度も向上します。
