# 店舗画像表示パフォーマンス調査・改善報告書

**日付:** 2025年12月18日
**担当:** Antigravity

## 概要
デプロイ環境における店舗画像の表示遅延に関する調査を行い、原因の特定と対策の実装を行いました。

## 調査結果

### 1. 原因の特定
コードベースおよび画像配信メカニズムを調査したところ、以下の問題が判明しました。

*   **Google Drive 画像のプロキシ配信仕様**:
    `netlify/functions/image-proxy.js` は、Google Drive の `uc?id=...` エンドポイントを使用していました。このエンドポイントは、リサイズを行わず**オリジナルサイズの画像をそのまま転送**します。
    多くの画像は数MB単位のサイズ（例: 4000x3000pxなど）であり、一覧表示（320x240px程度）において過剰なデータ転送が発生していました。
*   **フロントエンドの要求**:
    `src/App/ShopListItem.tsx` および `useShopData.ts` では、画像URL変換時にサイズ指定を行っていませんでした。

### 2. コンポーネント分析
*   `ShopListItem.tsx`: 一覧画面の各アイテムを表示。多くの画像を同時に読み込むため、ボトルネックとなっていました。
*   `image-proxy.js`: 画像の中継を行うサーバーレス関数。

## 解決策の実装

パフォーマンス改善のため、以下の変更を実施しました。

### バックエンド (Netlify Functions)
*   **サムネイルAPIへの切り替え**:
    `netlify/functions/image-proxy.js` を改修し、Google Drive の非公式ですが高速な `thumbnail` エンドポイント (`thumbnail?id=...&sz=w{width}`) を使用するように変更しました。
    これにより、Google側でリサイズされた軽量な画像が配信されるようになります。
*   **幅パラメータの追加**:
    `width` クエリパラメータを受け取れるようにし、指定がない場合はデフォルトで横幅 800px の画像を要求するようにしました。

### フロントエンド (React)
*   **適切なサイズのリクエスト**:
    `useShopData.ts` および `ShopListItem.tsx` を修正し、プロキシ経由で画像を取得する際に `width=600` を指定するようにしました。これにより、一覧表示に十分かつファイルサイズの小さい画像が取得されます。

## 検証
*   **ビルド検証**: `npm run build` を実行し、TypeScriptの型エラー等が発生しないことを確認しました。
*   **ロジック検証**: コードレビューにより、Google Drive ID の抽出とパラメータ付与が正しく行われていることを確認しました。

## 今後の推奨事項
*   ユーザーが画像をアップロードする運用の場合、元画像が非常に大きい可能性があるため、今回の対応は極めて有効です。
*   さらなる高速化が必要な場合は、Cloudinary などの画像専用CDNの導入を検討してください（今回はコストと既存環境維持を優先し、Google Drive + Netlify Functions の最適化を選択しました）。
